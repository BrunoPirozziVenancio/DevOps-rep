// Define uma pipeline Jenkins usando a sintaxe declarativa
pipeline {
    // Especifica que pode rodar em qualquer agente dispon칤vel
    agent any

    // Define vari치veis de ambiente que ser칚o usadas na pipeline
    environment {
        TF_DIR = 'infra-as-code/Terraform/OCI'       // Caminho para os arquivos Terraform, no caso tem que mudar para o arquivo que tem o .tf (Ex.: infra-as-code/Terraform/OCI/oci-instance-cloudinit)
        ANSIBLE_DIR = 'infra-as-code/Ansible/OCI'    // Caminho para os arquivos Ansible, no caso tem que mudar para o arquivo que tem o 
    }

    // Define os est치gios da pipeline (etapas sequenciais)
    stages {
        // Primeiro est치gio: Obter o c칩digo fonte do reposit칩rio
        stage('Checkout') {
            steps {
                checkout scm  // Comando padr칚o do Jenkins para fazer checkout do c칩digo
            }
        }

        // Segundo est치gio: Inicializar o Terraform
        stage('Terraform Init') {
            steps {
                dir("${TF_DIR}") {  // Entra no diret칩rio do Terraform
                    sh 'terraform init'  // Executa o comando de inicializa칞칚o
                }
            }
        }

        // Terceiro est치gio: Validar a configura칞칚o do Terraform
        stage('Terraform Validate') {
            steps {
                dir("${TF_DIR}") {
                    sh 'terraform validate'  // Valida a sintaxe e configura칞칫es
                }
            }
        }

        // Quarto est치gio: Gerar um plano de execu칞칚o do Terraform
        stage('Terraform Plan') {
            steps {
                dir("${TF_DIR}") {
                    // Cria um plano de execu칞칚o e salva em um arquivo chamado tfplan
                    sh 'terraform plan -out=tfplan'
                }
            }
        }

        // Quinto est치gio: Aplicar as mudan칞as do Terraform (apenas na branch main)
        stage('Terraform Apply') {
            when {  // Condi칞칚o para executar este est치gio
                branch 'main'  // S칩 executa se estiver na branch main
            }
            steps {
                dir("${TF_DIR}") {
                    // Aplica automaticamente o plano gerado anteriormente
                    sh 'terraform apply -auto-approve tfplan'
                }
            }
        }

        // Sexto est치gio: Executar o playbook Ansible
        stage('Ansible Deploy') {
            steps {
                dir("${ANSIBLE_DIR}") {  // Entra no diret칩rio do Ansible
                    // Executa o playbook chamado deploy.yml usando o arquivo hosts como invent치rio
                    sh 'ansible-playbook -i hosts deploy.yml'
                }
            }
        }
    }

    // Bloco que define a칞칫es p칩s-execu칞칚o (executadas independente do resultado)
    post {
        // Executa apenas se a pipeline falhar
        failure {
            echo 'Algo deu errado 游'  // Mensagem de erro amig치vel
        }
        // Executa apenas se a pipeline for bem sucedida
        success {
            echo 'Pipeline executada com sucesso! 游'  // Mensagem de sucesso
        }
    }
}
